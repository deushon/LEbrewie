# Решение проблемы с производительностью записи

## Проблема

После добавления новых датчиков (джойстик, IMU, моторы головы) видео в датасете стало воспроизводиться как будто на перемотке, а сам датасет выглядел ускоренным в 2 раза.

## Причина

Проблема возникла из-за увеличения времени обработки каждого кадра:

1. **Добавление новых датчиков** увеличило время получения наблюдений
2. **Система записи** все еще пытается поддерживать заданную частоту FPS (30 FPS)
3. **Фактическая частота** записи стала ниже из-за задержек обработки
4. **Временные метки** остаются такими же, как будто запись идет с заданной частотой
5. **Результат**: видео воспроизводится быстрее, чем записывалось

## Решение

### 1. Диагностика производительности

Запустите диагностический скрипт для измерения производительности:

```bash
python examples/brewie/performance_test.py
```

Этот скрипт покажет:
- Время получения данных с каждого датчика
- Общее время получения наблюдений
- Фактическую частоту записи
- Рекомендации по настройке

### 2. Оптимизация конфигурации

Используйте оптимизированную конфигурацию:

```python
# В record_config.py
config = RecordingConfig.optimized_with_sensors()
```

Эта конфигурация включает:
- **FPS: 15** (вместо 30) - сниженная частота для стабильности
- **image_writer_threads: 2** (вместо 4) - меньше потоков для стабильности
- Оптимизированные настройки для работы с новыми датчиками

### 3. Ручная настройка FPS

Если нужно настроить FPS вручную:

```python
config = RecordingConfig(
    fps=15,  # Снизьте до 15-20 FPS
    image_writer_threads=2,  # Уменьшите количество потоков
    # ... другие настройки
)
```

### 4. Рекомендуемые значения FPS

| Время обработки кадра | Рекомендуемый FPS | Описание |
|----------------------|-------------------|----------|
| < 25ms | 30 FPS | Оптимальная производительность |
| 25-40ms | 20-25 FPS | Хорошая производительность |
| 40-60ms | 15-20 FPS | Приемлемая производительность |
| > 60ms | 10-15 FPS | Низкая производительность |

## Дополнительные оптимизации

### 1. Отключение ненужных датчиков

Если некоторые датчики не нужны, можно временно отключить их подписки:

```python
# В Brewie_base.py, метод _setup_ros_topics()
# Закомментируйте ненужные подписки:

# self.joystick_subscriber = JoystickSubscriber(self.ros_client, self.joy_topic)
# self.joystick_subscriber.subscribe()

# self.imu_subscriber = IMUSubscriber(self.ros_client, self.imu_topic)
# self.imu_subscriber.subscribe()
```

### 2. Оптимизация логирования

Уменьшите уровень логирования для повышения производительности:

```python
import logging
logging.getLogger("lerobot.robots.brewie.Brewie_base").setLevel(logging.WARNING)
```

### 3. Проверка ROS подключения

Убедитесь, что ROS master работает стабильно:

```bash
# Проверьте статус ROS
rostopic list
rostopic hz /joy
rostopic hz /imu
```

## Проверка решения

После применения оптимизаций:

1. **Запустите диагностику**:
   ```bash
   python examples/brewie/performance_test.py
   ```

2. **Запишите тестовый датасет**:
   ```bash
   python examples/brewie/record_with_config.py
   ```

3. **Проверьте воспроизведение**:
   - Видео должно воспроизводиться с нормальной скоростью
   - Временные метки должны соответствовать реальному времени

## Мониторинг производительности

Добавлено логирование общего времени получения наблюдений:

```
[INFO] BrewieBase TOTAL observation time: 45.2ms
```

Это поможет отслеживать производительность в реальном времени.

## Предотвращение проблем в будущем

1. **Всегда тестируйте производительность** после добавления новых датчиков
2. **Используйте диагностический скрипт** перед записью больших датасетов
3. **Начинайте с низкой частоты записи** (15-20 FPS) и увеличивайте при необходимости
4. **Мониторьте логи** на предмет предупреждений о производительности

## Контакты

Если проблемы продолжаются, проверьте:
- Стабильность ROS подключения
- Производительность системы
- Настройки сети
- Версии используемых библиотек
